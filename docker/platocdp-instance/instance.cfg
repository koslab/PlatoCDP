[buildout]
parts = 
    instance
    instance-munin
    omelette
extends = buildout.cfg 

[config]
timezone = Asia/Kuala_Lumpur
additional-eggs = 
default-username = admin
default-password = admin
munin-secret = @@@!!!CHANGETHIS!!!@@@
zodb-cache-size=5000
zserver-threads = 4

dbname = platocdp
dbuser = platocdp
dbhost = postgres.local
dbpass = platocdp


[instance]
recipe = plone.recipe.zope2instance
http-address = 0.0.0.0:8080
eggs = 
    Plone
    Pillow
    plone.app.dexterity [grok]
    plone.app.async
    RelStorage
    psycopg2
    ${config:additional-eggs}

zodb-cache-size = ${config:zodb-cache-size}
user = ${config:default-username}:${config:default-password}
zserver-threads = ${config:zserver-threads}
effective-user = plone
event-log = ${buildout:log-directory}/${:_buildout_section_name_}.log
z2-log = ${buildout:log-directory}/${:_buildout_section_name_}-Z2.log

environment-vars =
    PYTHON_EGG_CACHE ${buildout:pyeggcache-directory}
    HOME ${buildout:directory}/var/
    TMPDIR ${buildout:directory}/var/tmp/
    zope_i18n_compile_mo_files true
    ZC_ASYNC_UUID ${buildout:directory}/var/${:_buildout_section_name_}-uuid.txt
    TZ ${config:timezone}

zcml-additional =
    <configure xmlns="http://namespaces.zope.org/zope">
        <include package="plone.app.async" file="multi_db_instance.zcml" />
    </configure>

rel-storage = 
    type postgresql
    blob-dir ${buildout:directory}/var/blobcache
    shared-blob-dir false
    dsn dbname='${config:dbname}' user='${config:dbuser}' host='${config:dbhost}' password='${config:dbpass}'

zope-conf-additional =
    <product-config munin.zope>
        secret ${config:munin-secret}
    </product-config>

    <zodb_db async>
        cache-size ${instance:zodb-cache-size}
        <relstorage>
            blob-dir ${buildout:directory}/var/blobcache
            shared-blob-dir false

            <postgresql>
                dsn dbname='${config:dbname}' user='${config:dbuser}' host='${config:dbhost}' password='${config:dbpass}'
            </postgresql>
        </relstorage>
        mount-point /zasync
    </zodb_db>

[instance-munin]
recipe = zc.recipe.egg
eggs = munin.zope
scripts = munin=${:_buildout_section_name_}
arguments = ip_address='127.0.0.1',
http_address='8080',  secret='${config:munin-secret}'

[omelette]
recipe = collective.recipe.omelette
eggs = ${instance:eggs}
